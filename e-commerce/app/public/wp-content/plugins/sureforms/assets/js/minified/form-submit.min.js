import{fieldValidation,initializeInlineFieldValidation,handleScrollAndFocusOnError,handleCaptchaValidation}from"./validation";import{applyFilters}from"@wordpress/hooks";import{__}from"@wordpress/i18n";function prepareAddressesData(e){e=e.querySelectorAll(".srfm-address-block");if(!e)return null;let s={};return e.forEach(e=>{var r=e.getAttribute("data-slug");r&&(e=e.querySelectorAll(".srfm-input-input, .srfm-dropdown-input"),e=Array.from(e).map(e=>e?.value?.trim()).filter(Boolean).join(", "),s[r]=e)}),0<Object.keys(s).length?s:null}async function submitFormData(e){var r,s,t=new FormData(e),o=new FormData,a=["srfm-email-confirm","srfm-password-confirm"];for([r,s]of t.entries())a.includes(r)||(""!==s&&(e.querySelector(`[name="${r}"]`)?.closest(".srfm-block-single"))?.classList.contains("hide-element")&&(s=""),o.append(r,s));t=prepareAddressesData(e);t&&o.append("srfm_addresses",JSON.stringify(t));try{return await wp.apiFetch({path:"sureforms/v1/submit-form",method:"POST",body:o})}catch(e){console.log(e)}}async function afterSubmit(e){e=e.data.submission_id;try{await wp.apiFetch({path:"/sureforms/v1/after-submission/"+e,method:"GET"})}catch(e){console.error(e)}}function showSuccessMessage(e,r,s,t,o,a,n){a=new CustomEvent("srfm_on_show_success_message",{cancelable:!0,detail:{form:t,element:r,message:s,submitType:a,container:e,loader:n}});document.dispatchEvent(a)&&("hide form"===o?(t.style.opacity=1,t.style.display="none",setTimeout(()=>{r.style.opacity=1},500)):"reset form"===o&&t.reset(),r.innerHTML=s,e.classList.add("srfm-active"),window?.srfm?.handleInstantFormWrapperHeight(),applyFilters("srfm.enableScrollOnSuccess",!0))&&t.parentElement.scrollIntoView({behavior:"smooth"})}function redirectToUrl(e){window.location.assign(e)}function dispatchErrorEvent(e){var{form:e,message:r="",position:s="footer",log_message:t=null}=e.detail||{};e&&(t&&console.warn(t),t=r||__("There was an error trying to submit your form. Please try again.","sureforms"),r=e.querySelector(".srfm-common-error-message."+("header"===s?"srfm-head-error":"srfm-footer-error")))&&(r.querySelector(".srfm-error-content").innerHTML=t,r.removeAttribute("hidden"),handleScrollAndFocusOnError({firstErrorInput:r,scrollElement:r}))}function showErrorMessage(e){var{form:e,message:r="",position:s="footer",log_message:t=null}=e,e=new CustomEvent("srfm_show_common_form_error",{detail:{form:e,message:r,position:s,log_message:t}});document.dispatchEvent(e)}function hideErrorMessage(e){e.querySelectorAll(".srfm-common-error-message").forEach(e=>{e.setAttribute("hidden",!0)})}async function handleFormSubmission(r,s,t,e,o,a,n,i,c,m,l,u,d,f){try{o.classList.add("srfm-active"),hideErrorMessage(r);var h,p,b=await fieldValidation(s,t,e,r),v=handleCaptchaValidation(l,u,d,f);b?.validateResult||!v?(o.classList.remove("srfm-active"),b?.validateResult?handleScrollAndFocusOnError(b):v||handleScrollAndFocusOnError({firstErrorInput:f,scrollElement:f})):(h=new CustomEvent("srfm_on_trigger_form_submission",{cancelable:!0,detail:{form:r,loader:o,formId:s,submitType:c,successElement:i,successContainer:n}}),document.dispatchEvent(h)?(p=await submitFormData(r))?.success?(emitFormSubmitSuccess({...p,formId:s}),"same page"===c?(showSuccessMessage(n,i,p?.message??"",r,m,c),o.classList.remove("srfm-active")):["different page","custom url"].includes(c)?(p?.redirect_url&&redirectToUrl(p?.redirect_url),o.classList.remove("srfm-active")):showSuccessMessage(n,i,p?.message??"",r,m,c,o),p?.data?.after_submit&&afterSubmit(p)):(showErrorMessage({form:r,...p?.data||{}}),o.classList.remove("srfm-active")):o.classList.remove("srfm-active"))}catch(e){t=new CustomEvent("srfm_on_trigger_form_submission_failure",{detail:{form:r,error:e,loader:o,formId:s,submitType:c,successElement:i,successContainer:n}});document.dispatchEvent(t),o.classList.remove("srfm-active"),showErrorMessage({form:r})}}function extractFormAttributesAndElements(e){var r=e.getAttribute("form-id"),s=e.getAttribute("message-type"),t=e.getAttribute("success-url"),o=e.getAttribute("ajaxurl"),a=e.getAttribute("data-nonce"),n=e.querySelector(".srfm-loader"),i=e.parentElement.querySelector(".srfm-single-form.srfm-success-box"),c=i?.querySelector(".srfm-success-box-description"),m=e.querySelector("#srfm-submit-btn"),l=e.getAttribute("after-submission"),u=e.querySelector(".g-recaptcha");return{formId:r,submitType:s,successUrl:t,ajaxUrl:o,nonce:a,loader:n,successContainer:i,successElement:c,submitBtn:m,siteKey:u?.getAttribute("data-sitekey"),recaptchaType:u?.getAttribute("recaptcha-type"),afterSubmission:l,captchaErrorElement:e.querySelector("#captcha-error"),hCaptchaDiv:e.querySelector(".h-captcha"),turnstileDiv:e.querySelector(".cf-turnstile")}}function recaptchaCallback(h=""){Array.from(document.querySelectorAll(".srfm-form")).forEach(e=>{let{formId:r,submitType:s,successUrl:t,ajaxUrl:o,nonce:a,loader:n,successContainer:i,successElement:c,submitBtn:m,siteKey:l,recaptchaType:u,afterSubmission:d}=extractFormAttributesAndElements(e),f=!1;"v2-invisible"===u&&(grecaptcha.render(m,{sitekey:l,callback:()=>{handleFormSubmission(e,r,o,a,n,t,i,c,s,d),f=!0},"error-callback":()=>{showErrorMessageOnRecaptchaError({containerSelector:'.g-recaptcha[recaptcha-type="v2-invisible"]:not(.captcha-error-added)',message:srfm_submit?.messages?.srfm_google_captcha_error_message})}}),m.addEventListener("click",()=>{n.classList.add("srfm-active"),f&&handleFormSubmission(e,r,o,a,n,t,i,c,s,d)})),"v3-reCAPTCHA"===u&&h&&(n.classList.add("srfm-active"),handleFormSubmission(e,r,o,a,n,t,i,c,s,d))})}function showErrorMessageOnRecaptchaError(e){let{containerSelector:r,message:s=""}=e;e=document.querySelectorAll(r);e&&e.forEach(e=>{var r=e.closest(".srfm-form");r&&(showErrorMessage({form:r,message:s}),e.classList.add("captcha-error-added"))})}function emitFormSubmitSuccess(e){e=new CustomEvent("srfm_form_submission_success",{detail:{formId:"srfm-form-"+e.formId}});document.dispatchEvent(e)}document.addEventListener("DOMContentLoaded",function(){initializeInlineFieldValidation();for(let b of Array.from(document.querySelectorAll(".srfm-form"))){let{formId:s,submitType:t,successUrl:o,ajaxUrl:a,nonce:n,loader:i,successContainer:c,successElement:m,recaptchaType:l,afterSubmission:u,captchaErrorElement:d,hCaptchaDiv:f,turnstileDiv:h}=extractFormAttributesAndElements(b),p="v2-checkbox"===l||!!f||!!h;b.addEventListener("submit",async e=>{e.preventDefault();e=e.target;if("FORM"===e?.tagName){var r=(e?.closest(".srfm-form-container"))?.classList.contains("srfm-submit-button-hidden"),e=e?.querySelector("button.srfm-custom-button");if(r&&!e)return void console.warn("Form submission is disabled because the submit button is hidden.")}handleFormSubmission(b,s,a,n,i,o,c,m,t,u,p?l:void 0,p?f:void 0,p?h:void 0,p?d:void 0)})}}),document.addEventListener("srfm_show_common_form_error",dispatchErrorEvent),window.recaptchaCallback=recaptchaCallback,window.handleBricksPreviewFormSubmission=function(){var e;for(e of Array.from(document.querySelectorAll(".srfm-form")))e.addEventListener("submit",async function(e){e.preventDefault()})};